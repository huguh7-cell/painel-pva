rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helpers
    function isAuthed() { return request.auth != null; }
    function isADA(empresaId) { return empresaId == "ADA"; }
    function nonNegative(n) { return n is number && n >= 0; }
    function sameCompanyOnCreate(empresaId) {
      return request.resource.data.empresaId == empresaId && isADA(empresaId);
    }
    function sameCompanyOnUpdate(empresaId) {
      return resource.data.empresaId == empresaId &&
             request.resource.data.empresaId == resource.data.empresaId &&
             isADA(empresaId);
    }

    // /companies/{empresaId}/(avarias|encomendas|inventario)
    match /companies/{empresaId} {

      match /avarias/{id} {
        allow create: if isAuthed() &&
                       sameCompanyOnCreate(empresaId) &&
                       request.resource.data.data is string &&
                       request.resource.data.hora is string &&
                       request.resource.data.tear is string &&
                       request.resource.data.tipo is string &&
                       request.resource.data.descricao is string &&
                       (request.resource.data.tecnico == null || request.resource.data.tecnico is string) &&
                       (request.resource.data.tempoParagem == null || nonNegative(request.resource.data.tempoParagem)) &&
                       (request.resource.data.pecaId == null || request.resource.data.pecaId is string) &&
                       (request.resource.data.pecaQtd == null || nonNegative(request.resource.data.pecaQtd));
        allow update: if isAuthed() &&
                       sameCompanyOnUpdate(empresaId) &&
                       (request.resource.data.tempoParagem == null || nonNegative(request.resource.data.tempoParagem)) &&
                       (request.resource.data.pecaQtd == null || nonNegative(request.resource.data.pecaQtd));
        allow read:   if isAuthed() && isADA(empresaId);
        allow delete: if isAuthed() &&
                       resource.data.empresaId == empresaId &&
                       isADA(empresaId);
      }

      match /encomendas/{id} {
        allow create: if isAuthed() &&
                       sameCompanyOnCreate(empresaId) &&
                       request.resource.data.data is string &&
                       request.resource.data.cliente is string &&
                       request.resource.data.produto is string &&
                       (request.resource.data.quantidadeM == null || nonNegative(request.resource.data.quantidadeM)) &&
                       (request.resource.data.larguraCm == null || nonNegative(request.resource.data.larguraCm)) &&
                       (request.resource.data.prioridade == null || request.resource.data.prioridade is string) &&
                       request.resource.data.tear is string &&
                       (request.resource.data.observacoes == null || request.resource.data.observacoes is string);
        allow update: if isAuthed() &&
                       sameCompanyOnUpdate(empresaId) &&
                       (request.resource.data.quantidadeM == null || nonNegative(request.resource.data.quantidadeM)) &&
                       (request.resource.data.larguraCm == null || nonNegative(request.resource.data.larguraCm));
        allow read:   if isAuthed() && isADA(empresaId);
        allow delete: if isAuthed() &&
                       resource.data.empresaId == empresaId &&
                       isADA(empresaId);
      }

      match /inventario/{id} {
        allow create: if isAuthed() &&
                       sameCompanyOnCreate(empresaId) &&
                       (request.resource.data.codigo == null || request.resource.data.codigo is string) &&
                       request.resource.data.nome is string &&
                       (request.resource.data.local == null || request.resource.data.local is string) &&
                       (request.resource.data.stock == null || nonNegative(request.resource.data.stock)) &&
                       (request.resource.data.min == null   || nonNegative(request.resource.data.min));
        allow update: if isAuthed() &&
                       sameCompanyOnUpdate(empresaId) &&
                       (request.resource.data.stock == null || nonNegative(request.resource.data.stock)) &&
                       (request.resource.data.min == null   || nonNegative(request.resource.data.min));
        allow read:   if isAuthed() && isADA(empresaId);
        allow delete: if isAuthed() &&
                       resource.data.empresaId == empresaId &&
                       isADA(empresaId);
      }
    }
  }
}
