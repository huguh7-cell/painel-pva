<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Painel Operacional</title>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#0b1020" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="Painel" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/icon-180.png?v=2" />

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>

  <style>
    :root { --bg:#0b1020; --card:#11162a; --muted:#a2a9c3; --accent:#3b82f6; --danger:#ef4444; --ok:#10b981; }
    body { margin:0; background:var(--bg); color:#fff; font:15px/1.4 system-ui,-apple-system,Segoe UI,Roboto,sans-serif; }
    .wrap { max-width:1200px; margin:0 auto; padding:16px; }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .card { background:var(--card); border-radius:12px; padding:16px; margin-top:16px; }
    .grid2 { display:grid; gap:16px; grid-template-columns:repeat(2,minmax(0,1fr)); }
    .grid3 { display:grid; gap:16px; grid-template-columns:repeat(3,minmax(0,1fr)); }
    .grid4 { display:grid; gap:12px; grid-template-columns:repeat(4,minmax(0,1fr)); }
    @media (max-width:1024px){ .grid3 { grid-template-columns:1fr; } }
    @media (max-width:900px){ .grid2,.grid4 { grid-template-columns:1fr; } }
    .muted { color:var(--muted); font-size:13px; }
    .input, select, textarea { background:#0f1530; border:1px solid #2a3550; color:#fff; border-radius:8px; padding:8px 10px; width:100%; }
    textarea { min-height:70px; resize:vertical; }
    .btn { background:var(--accent); color:#fff; border:0; border-radius:8px; padding:8px 12px; font-weight:600; cursor:pointer; }
    .btn-ghost { background:transparent; color:#fff; border:1px solid #2a3550; border-radius:8px; padding:8px 12px; cursor:pointer; }
    .btn-danger { background:var(--danger); }
    .btn-ok { background:var(--ok); }
    table { width:100%; border-collapse:collapse; font-size:14px; }
    th, td { border-bottom:1px solid #233; padding:8px; vertical-align:top; }
    thead th { position:sticky; top:0; background:#0f1530; }
    .scroll { max-height:360px; overflow:auto; border:1px solid #233; border-radius:8px; }
    .badge { background:#1f2a44; border-radius:6px; padding:2px 6px; font-size:12px; }
    .badge-red { background:#3a1020; color:#fecaca; }
    .toolbar { display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin:8px 0 12px; }
    .btn-ghost.active { outline:2px solid #3b82f6; }
    .toolbar-spacer { color:var(--muted); }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row">
      <div>
        <h1 style="margin:8px 0">Painel Operacional</h1>
        <div class="muted">Avarias • Encomendas • Inventário — 112 teares (sincronizado)</div>
      </div>
    </div>

    <!-- Seleção de Tear -->
    <div class="card">
      <div class="grid4">
        <div>
          <label>Tear</label>
          <select id="selTear"></select>
        </div>
        <div>
          <label>Nome</label>
          <input class="input" id="inpTearNome" readonly />
        </div>
      </div>
    </div>

    <!-- Aqui continuam os cartões de Avarias, Encomendas e Inventário -->
    <!-- ... (código idêntico ao que te enviei antes) ... -->

  </div>

  <script>
    // Firebase config (o teu já incluído)
    const firebaseConfig = {
      apiKey: "AIzaSyDLmIafdPeq6Aq5ZVeng6v5jJviDqs4rDk",
      authDomain: "painel-ada.firebaseapp.com",
      projectId: "painel-ada",
      storageBucket: "painel-ada.firebasestorage.app",
      messagingSenderId: "10091976296",
      appId: "1:10091976296:web:6d4de4c127e32431274ddd",
      measurementId: "G-XH2RYBTKX5"
    };
    const EMPRESA_ID = "ADA";

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Helpers
    const TEARES = Array.from({ length: 112 }, (_, i) => ({
      codigo: "TEC-" + String(i + 1).padStart(3,"0"),
      nome: "Tear " + String(i + 1).padStart(2,"0")
    }));

    // === PATCHES: usar closest só se existir ===
    function safeClosest(target, selector) {
      return target && target.closest ? target.closest(selector) : null;
    }

    // === Teares ===
    const selTear = document.getElementById("selTear");
    const inpTearNome = document.getElementById("inpTearNome");
    TEARES.forEach(t=>{
      const opt=document.createElement("option");
      opt.value=t.codigo;
      opt.textContent=`${t.codigo} — ${t.nome}`;
      selTear.appendChild(opt);
    });
    selTear.value=TEARES[0].codigo;
    inpTearNome.value=TEARES[0].nome;
    selTear.addEventListener("change",()=>{
      inpTearNome.value=(TEARES.find(t=>t.codigo===selTear.value)||{}).nome||"";
    });

    // Exemplo de listener corrigido
    const avToolbar=document.getElementById("avToolbar");
    if(avToolbar){
      avToolbar.addEventListener("click",(e)=>{
        const btn=safeClosest(e.target,"button");
        if(!btn) return;
        // resto da lógica...
      });
    }

    // Idem para outros toolbars e tabelas...

    // SW update v4 (forçar refresh)
    if("serviceWorker" in navigator){
      window.addEventListener("load",()=>{
        navigator.serviceWorker.register("/sw.js?v=4").catch(()=>{});
      });
    }
  </script>
</body>
</html>
